---
phase: 05-persistence-semantic-memory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/db/index.ts
  - src/db/sessions.ts
  - src/types/session.ts
  - src/hooks/useAutoSave.ts
  - src/hooks/useSessions.ts
  - src/stores/sessionStore.ts
  - src/App.tsx
autonomous: true
must_haves:
  truths:
    - "Session state (chat messages, mermaid source, undo/redo history, diagram position) is saved to IndexedDB"
    - "Auto-save fires continuously in the background on state changes"
    - "User can create a new session which auto-saves current work first"
    - "Session records include auto-generated name and last modified timestamp"
  artifacts:
    - path: "src/db/index.ts"
      provides: "Dexie database class with sessions and memories tables"
      contains: "class InstantCoffeeDB"
    - path: "src/db/sessions.ts"
      provides: "Session CRUD operations (create, load, update, delete, list)"
      exports: ["createSession", "loadSession", "updateSession", "deleteSession", "listSessions"]
    - path: "src/types/session.ts"
      provides: "Session and SessionState type definitions"
      exports: ["Session", "SessionState"]
    - path: "src/hooks/useAutoSave.ts"
      provides: "Debounced auto-save hook that fires on state changes"
      exports: ["useAutoSave"]
    - path: "src/hooks/useSessions.ts"
      provides: "Session list hook with reactive Dexie queries"
      exports: ["useSessions"]
    - path: "src/stores/sessionStore.ts"
      provides: "Zustand store for current session ID and unsaved changes flag"
      exports: ["useSessionStore"]
  key_links:
    - from: "src/hooks/useAutoSave.ts"
      to: "src/db/sessions.ts"
      via: "calls updateSession on debounced state changes"
      pattern: "updateSession"
    - from: "src/hooks/useSessions.ts"
      to: "src/db/index.ts"
      via: "useLiveQuery for reactive session list"
      pattern: "useLiveQuery"
    - from: "src/App.tsx"
      to: "src/hooks/useAutoSave.ts"
      via: "passes current state to auto-save hook"
      pattern: "useAutoSave"
---

<objective>
Set up Dexie.js database, session persistence types, auto-save infrastructure, and session CRUD operations.

Purpose: Foundation for saving/loading sessions. After this plan, session state auto-saves to IndexedDB and can be loaded back. No UI for session switching yet (that's plan 03).
Output: Database layer, session types, auto-save hook, session store, and App.tsx wired to auto-save.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-persistence-semantic-memory/05-CONTEXT.md
@.planning/phases/05-persistence-semantic-memory/05-RESEARCH.md
@src/App.tsx
@src/hooks/useChat.ts
@src/types/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create database + types</name>
  <files>
    package.json
    src/db/index.ts
    src/db/sessions.ts
    src/types/session.ts
  </files>
  <action>
    1. Install dependencies:
       `npm install dexie dexie-react-hooks zustand`
       (No lodash.debounce needed — use a simple useRef-based debounce inline)

    2. Create `src/types/session.ts`:
       - `interface SessionState` containing:
         - `messages: ChatMessage[]` (import from `@/types/chat`)
         - `mermaidSource: string`
         - `history: string[]` (undo/redo stack)
         - `historyIndex: number`
       - `interface Session` containing:
         - `id?: number` (Dexie auto-increment)
         - `name: string` (auto-generated from first user message)
         - `createdAt: number` (Unix timestamp)
         - `updatedAt: number` (Unix timestamp)
         - `state: SessionState`

    3. Create `src/db/index.ts`:
       - Export a `class InstantCoffeeDB extends Dexie` with:
         - `sessions!: Table<Session, number>`
         - `memories!: Table<Memory, number>` (table created now, Memory type used in plan 02)
       - Schema version 1:
         - `sessions: '++id, name, updatedAt'`
         - `memories: '++id, category, name'`
       - Export singleton `const db = new InstantCoffeeDB()`

    4. Create `src/db/sessions.ts`:
       - `createSession(state: SessionState): Promise<number>` — creates session with auto-generated name derived from first user message content (truncated to 50 chars), or "New Diagram" if no messages. Sets createdAt and updatedAt to Date.now().
       - `loadSession(id: number): Promise<Session | undefined>` — fetches by id
       - `updateSession(id: number, state: SessionState): Promise<void>` — updates state and sets updatedAt to Date.now()
       - `deleteSession(id: number): Promise<void>` — deletes by id
       - `listSessions(): Promise<Session[]>` — returns all sessions ordered by updatedAt descending
       - `renameSession(id: number, name: string): Promise<void>` — updates name
  </action>
  <verify>
    `npm run build` succeeds with no TypeScript errors. Check that `src/db/index.ts`, `src/db/sessions.ts`, and `src/types/session.ts` exist and export the expected symbols.
  </verify>
  <done>
    Dexie database class exists with sessions and memories tables. Session type and all CRUD functions are defined and exported. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session store, auto-save hook, and wire into App.tsx</name>
  <files>
    src/stores/sessionStore.ts
    src/hooks/useAutoSave.ts
    src/hooks/useSessions.ts
    src/App.tsx
  </files>
  <action>
    1. Create `src/stores/sessionStore.ts`:
       - Zustand store with:
         - `currentSessionId: number | null`
         - `hasUnsavedChanges: boolean`
         - `setCurrentSessionId(id: number | null): void`
         - `setHasUnsavedChanges(value: boolean): void`

    2. Create `src/hooks/useAutoSave.ts`:
       - Takes `{ sessionState: SessionState, enabled: boolean }` as argument
       - Uses a `useRef` to hold a debounce timer (1500ms delay)
       - On `sessionState` change (deep compare with JSON.stringify of a stable subset — messages length, mermaidSource, historyIndex):
         - Sets `hasUnsavedChanges = true` in session store
         - Clears previous timer, starts new 1500ms timer
         - When timer fires: if `currentSessionId` exists, calls `updateSession(currentSessionId, sessionState)`. If no currentSessionId, calls `createSession(sessionState)` and sets the returned id as `currentSessionId`.
         - After successful save, sets `hasUnsavedChanges = false`
       - On unmount, flush any pending save immediately (call the save without debounce)

    3. Create `src/hooks/useSessions.ts`:
       - Uses `useLiveQuery` from `dexie-react-hooks` to reactively query `db.sessions.orderBy('updatedAt').reverse().toArray()`
       - Returns `{ sessions: Session[] | undefined, isLoading: boolean }`
       - `isLoading` is true when `sessions` is undefined (initial load)

    4. Update `src/App.tsx`:
       - Import `useAutoSave`, `useSessionStore`, `SessionState`
       - Build a `SessionState` object from current state: `{ messages: chat.messages, mermaidSource, history, historyIndex }`
       - Call `useAutoSave({ sessionState, enabled: true })`
       - Add a `loadSessionState(state: SessionState)` function that:
         - Sets `chat.messages` (will need to expose `setMessages` from useChat — see below)
         - Sets `mermaidSource`, `history`, `historyIndex`
         - Re-renders the mermaid from `state.mermaidSource`
       - Expose `setMessages` from `useChat` hook: add `setMessages` to the return value of `useChat` in `src/hooks/useChat.ts`
       - Add `handleNewSession` function: auto-saves current state (flush), then resets all state to defaults (empty messages, DEMO_MERMAID, fresh history), sets currentSessionId to null (new session will be auto-created on first change)
       - Note: Session sidebar UI and load/switch functionality will be added in plan 03. For now, just the auto-save wiring and the state loading function.
  </action>
  <verify>
    `npm run build` succeeds. Open the app in browser, send a chat message, check browser DevTools > Application > IndexedDB > InstantCoffeeDB > sessions table — a session record should appear within ~2 seconds with the chat message in state.messages.
  </verify>
  <done>
    Auto-save fires on state changes and persists session to IndexedDB. Zustand store tracks current session ID and unsaved changes flag. useChat exposes setMessages. App.tsx has loadSessionState and handleNewSession functions ready for UI wiring in plan 03.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. App loads in browser without console errors
3. After sending a message, IndexedDB contains a session record with messages, mermaidSource, history, and historyIndex
4. Session record has auto-generated name, createdAt, and updatedAt timestamps
5. After modifying the diagram (via chat or editor), the session record in IndexedDB updates within ~2 seconds
</verification>

<success_criteria>
- Dexie database with sessions table is functional
- Session CRUD operations work correctly
- Auto-save persists state to IndexedDB on changes
- Session store tracks current session and unsaved changes
- App.tsx is wired to auto-save and has functions for loading/resetting sessions
</success_criteria>

<output>
After completion, create `.planning/phases/05-persistence-semantic-memory/05-01-SUMMARY.md`
</output>
