---
phase: 04-switch-from-d2-to-mermaid
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/mermaid.ts
  - src/lib/ollama.ts
  - src/hooks/useChat.ts
  - src/types/chat.ts
autonomous: true

must_haves:
  truths:
    - "Mermaid source renders to SVG client-side without backend"
    - "LLM responses with ```mermaid code blocks are correctly extracted"
    - "System prompt instructs LLM to generate Mermaid syntax, not D2"
    - "Streaming diagram updates work with Mermaid rendering"
  artifacts:
    - path: "src/lib/mermaid.ts"
      provides: "Client-side Mermaid rendering"
      exports: ["renderMermaid", "initMermaid"]
    - path: "src/lib/ollama.ts"
      provides: "Mermaid code extraction from LLM responses"
      exports: ["extractMermaidCode"]
    - path: "src/hooks/useChat.ts"
      provides: "Chat hook using Mermaid rendering"
  key_links:
    - from: "src/hooks/useChat.ts"
      to: "src/lib/mermaid.ts"
      via: "import renderMermaid"
      pattern: "import.*renderMermaid.*from.*mermaid"
    - from: "src/hooks/useChat.ts"
      to: "src/lib/ollama.ts"
      via: "import extractMermaidCode"
      pattern: "extractMermaidCode"
---

<objective>
Replace the D2 CLI rendering pipeline with client-side Mermaid.js rendering. Update the Ollama integration to extract Mermaid code blocks and the system prompt to instruct the LLM to generate Mermaid syntax.

Purpose: Core engine swap from D2 (backend CLI) to Mermaid (client-side JS) — all downstream UI components consume SVG from this pipeline.
Output: Working Mermaid rendering library, updated code extraction, and chat hook wired to Mermaid.
</objective>

<execution_context>
@/Users/dan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-switch-from-d2-to-mermaid/04-RESEARCH.md
@src/lib/d2.ts
@src/lib/ollama.ts
@src/hooks/useChat.ts
@src/types/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Mermaid rendering library and update code extraction</name>
  <files>src/lib/mermaid.ts, src/lib/ollama.ts</files>
  <action>
1. Install mermaid: run `npm install mermaid` and verify `mermaid` appears in `dependencies` in `package.json`

2. Create `src/lib/mermaid.ts` replacing `src/lib/d2.ts`:
   - Export `initMermaid()` that calls `mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'strict', logLevel: 'error', flowchart: { useMaxWidth: true, htmlLabels: true } })`
   - Export `renderMermaid(mermaidSource: string): Promise<string>` that:
     - Generates a unique ID: `mermaid-${Date.now()}-${Math.random().toString(36).substring(7)}`
     - Calls `const { svg } = await mermaid.render(uniqueId, mermaidSource)`
     - Returns the SVG string
     - Wraps in try/catch, re-throws with descriptive error message
   - Keep the `RenderResponse` interface export for compatibility
   - Do NOT delete `src/lib/d2.ts` yet (Plan 02 handles cleanup after all imports are updated)

3. Update `src/lib/ollama.ts`:
   - Rename `extractD2Code` to `extractMermaidCode`
   - Change the regex from `/```d2\n([\s\S]*?)```/` to `/```mermaid\s*\n([\s\S]*?)```/`
   - Update return type from `{ explanation: string; d2Code: string }` to `{ explanation: string; mermaidCode: string }`
   - Remove the D2-specific fallback heuristic (the `if (response.includes(':') && response.includes('['))` block) — Mermaid syntax is different enough that this heuristic doesn't apply
   - Return `{ explanation: response, mermaidCode: '' }` for no-match case
   - Keep all other functions (`streamChat`, `checkOllamaHealth`, `formatError`) unchanged
  </action>
  <verify>
    - `mermaid` appears in package.json dependencies
    - `src/lib/mermaid.ts` exists and exports `renderMermaid` and `initMermaid`
    - `src/lib/ollama.ts` exports `extractMermaidCode` (not `extractD2Code`)
  </verify>
  <done>
    - Mermaid rendering function exists and uses client-side mermaid.render() API
    - Code extraction matches ```mermaid blocks and returns mermaidCode field
    - No D2-specific logic remains in ollama.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useChat hook for Mermaid pipeline</name>
  <files>src/hooks/useChat.ts</files>
  <action>
1. Update imports:
   - Change `import { renderD2 } from '../lib/d2'` to `import { renderMermaid } from '../lib/mermaid'`
   - Change `extractD2Code` to `extractMermaidCode` in the import from `'../lib/ollama'`

2. Rewrite `SYSTEM_PROMPT` constant for Mermaid syntax:
   ```
   You are a Mermaid diagram generation assistant. Your role is to help users create diagrams by generating Mermaid code based on their descriptions.

   You can generate the following types of diagrams:
   - flowchart (process flows, decision trees, architecture)
   - sequenceDiagram (interactions between actors/components)
   - erDiagram (entity-relationship diagrams)
   - graph (general directed graphs)

   ITERATIVE REFINEMENT:
   When user requests changes to an existing diagram, you must MODIFY the CURRENT DIAGRAM below, not create a new one from scratch.

   CRITICAL: Always output ONLY the modified Mermaid code. Do NOT explain what changed.

   When generating diagrams:
   1. Use proper Mermaid syntax: https://mermaid.js.org/
   2. Always wrap code in markdown code blocks with the 'mermaid' language identifier
   3. Keep diagrams clear and readable
   4. Do NOT use emoji or special unicode characters in node labels
   5. Always specify diagram type on the first line (flowchart TD, sequenceDiagram, erDiagram, etc.)

   Format your response like this:
   ```mermaid
   flowchart TD
       A[Start] --> B[End]
   ```

   If the user asks to modify an existing diagram, output the complete modified Mermaid code (not just the changes).
   ```

3. Rename state variables:
   - `currentD2` → `currentMermaid` (state variable)
   - `setCurrentD2` → `setCurrentMermaid`
   - `_partialD2` / `setPartialD2` → `_partialMermaid` / `setPartialMermaid`
   - `partialD2Ref` → `partialMermaidRef`

4. Update `toOllamaMessages`:
   - Change `currentD2` reference to `currentMermaid`
   - Change the injected code block from ````d2` to ````mermaid`
   - Change `msg.d2Source` references to `msg.mermaidSource` (type updated in Task 2 step 8)

5. Update streaming callbacks:
   - `extractD2Code` → `extractMermaidCode`
   - `d2Code` → `mermaidCode` (destructured field name)
   - `renderD2(d2Code)` → `renderMermaid(mermaidCode)`
   - Console warnings: "Partial D2 render failed" → "Partial Mermaid render failed"
   - `setCurrentD2(d2Code)` → `setCurrentMermaid(mermaidCode)`

6. Update `onComplete` callback:
   - `extractD2Code` → `extractMermaidCode`
   - `d2Code` → `mermaidCode`
   - `renderD2(d2Code)` → `renderMermaid(mermaidCode)`
   - Warning messages: "No D2 code" → "No Mermaid code", "Failed to render D2" → "Failed to render diagram"
   - `assistantMessage.d2Source = d2Code` → `assistantMessage.mermaidSource = mermaidCode`

7. Update return object:
   - `currentD2` → `currentMermaid`
   - `partialD2` → `partialMermaid`

8. Update `src/types/chat.ts`: rename the `d2Source` field on `ChatMessage` interface to `mermaidSource`.
  </action>
  <verify>
    - `npm run build` compiles. Expected warnings: `renderD2` imported but not used in App.tsx and SourceEditorModal.tsx (Plan 02 fixes those). Any other errors are blockers.
    - `useChat.ts` imports from `'../lib/mermaid'` not `'../lib/d2'`
    - System prompt contains "Mermaid" not "D2"
    - All `renderD2` calls replaced with `renderMermaid`
  </verify>
  <done>
    - useChat hook generates Mermaid diagrams via Ollama
    - System prompt instructs LLM to output ```mermaid code blocks
    - Streaming debounce renders partial Mermaid client-side
    - Return values use mermaid naming (currentMermaid, partialMermaid)
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors (some warnings acceptable if App.tsx still references old d2 imports — Plan 02 fixes)
- `src/lib/mermaid.ts` contains `mermaid.render()` call with unique ID generation
- `src/lib/ollama.ts` has `extractMermaidCode` function matching ```mermaid blocks
- `src/hooks/useChat.ts` system prompt references Mermaid syntax
- No `renderD2` calls remain in `useChat.ts`
</verification>

<success_criteria>
The core rendering pipeline is swapped from D2 CLI (backend) to Mermaid.js (client-side). The chat hook, code extraction, and system prompt all target Mermaid syntax. The old d2.ts file still exists but is no longer imported by the chat pipeline.
</success_criteria>

<output>
After completion, create `.planning/phases/04-switch-from-d2-to-mermaid/04-01-SUMMARY.md`
</output>
