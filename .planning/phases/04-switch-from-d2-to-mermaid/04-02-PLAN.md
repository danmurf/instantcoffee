---
phase: 04-switch-from-d2-to-mermaid
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/App.tsx
  - src/components/SourceEditorModal.tsx
  - package.json
  - vite.config.ts
  - server/index.js
  - src/lib/d2.ts
  - CLAUDE.md
  - README.md
  - AGENTS.md
  - .gitignore
  - .planning/PROJECT.md
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
  - .planning/STATE.md
autonomous: false

must_haves:
  truths:
    - "App loads and renders a demo Mermaid diagram without backend server"
    - "Source editor modal shows 'Mermaid' labels and renders preview client-side"
    - "npm run dev starts only the Vite dev server (no Express)"
    - "D2 CLI and Express backend are no longer required"
    - "User can visually verify the app works end-to-end with Mermaid"
  artifacts:
    - path: "src/App.tsx"
      provides: "App with Mermaid demo diagram and rendering"
    - path: "src/components/SourceEditorModal.tsx"
      provides: "Editor modal using Mermaid rendering"
    - path: "package.json"
      provides: "Updated scripts and dependencies"
    - path: "vite.config.ts"
      provides: "Config without /api proxy"
  key_links:
    - from: "src/App.tsx"
      to: "src/lib/mermaid.ts"
      via: "import renderMermaid"
      pattern: "import.*renderMermaid.*from.*mermaid"
    - from: "src/components/SourceEditorModal.tsx"
      to: "src/lib/mermaid.ts"
      via: "import renderMermaid"
      pattern: "import.*renderMermaid.*from.*mermaid"
---

<objective>
Complete the D2-to-Mermaid migration by updating all UI components, removing the Express backend, and cleaning up project configuration.

Purpose: Finish the migration so the app runs entirely client-side with no D2 or Express dependency.
Output: Fully working app with Mermaid rendering, cleaned up dependencies and scripts.
</objective>

<execution_context>
@/Users/dan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-switch-from-d2-to-mermaid/04-01-SUMMARY.md
@src/App.tsx
@src/components/SourceEditorModal.tsx
@src/lib/mermaid.ts
@package.json
@vite.config.ts
@server/index.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update App.tsx and SourceEditorModal for Mermaid</name>
  <files>src/App.tsx, src/components/SourceEditorModal.tsx</files>
  <action>
1. Update `src/App.tsx`:
   - Change import from `import { renderD2 } from './lib/d2'` to `import { renderMermaid, initMermaid } from './lib/mermaid'`
   - Replace `DEMO_D2` constant with a Mermaid demo diagram:
     ```
     const DEMO_MERMAID = `flowchart TD
         A[Hello] -->|says hello| B[World]
         B --> C[Hello, World!]
         style A fill:#f0f9ff,stroke:#6366f1
         style B fill:#f0f9ff,stroke:#6366f1
         style C fill:#f0f9ff,stroke:#6366f1
     `;
     ```
   - Call `initMermaid()` at module level before the App component definition (one-time global init, not in useEffect)
   - Rename all `d2Source`/`setD2Source` state to `mermaidSource`/`setMermaidSource`
   - Update `chat.currentD2` references to `chat.currentMermaid`
   - Replace all `renderD2(...)` calls with `renderMermaid(...)`
   - Update `DEMO_D2` references to `DEMO_MERMAID`
   - Update history initial state from `[DEMO_D2]` to `[DEMO_MERMAID]`
   - Update `SourceEditorModal` prop from `d2Source={d2Source}` to `mermaidSource={mermaidSource}`

2. Update `src/components/SourceEditorModal.tsx`:
   - Change import from `import { renderD2 } from '../lib/d2'` to `import { renderMermaid } from '../lib/mermaid'`
   - Rename prop `d2Source` to `mermaidSource` in the interface `SourceEditorModalProps`
   - Update JSDoc comment: "current D2 source code" → "current Mermaid source code"
   - Rename internal state: `localSource` can stay (generic enough)
   - Update `renderD2(localSource)` → `renderMermaid(localSource)`
   - Change heading text: "Edit D2 Source" → "Edit Mermaid Source"
   - Change placeholder: "Enter D2 source code..." → "Enter Mermaid source code..."
  </action>
  <verify>
    - `npm run build` compiles without errors
    - No references to `d2` or `D2` remain in App.tsx or SourceEditorModal.tsx (except possibly CSS class names or generic text)
    - SourceEditorModal accepts `mermaidSource` prop
  </verify>
  <done>
    - App renders a Mermaid demo diagram on load
    - Source editor shows "Mermaid" in labels and renders preview via client-side Mermaid
    - All D2 references removed from UI layer
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove Express backend and clean up project config</name>
  <files>server/index.js, src/lib/d2.ts, package.json, vite.config.ts, CLAUDE.md</files>
  <action>
1. Delete `server/index.js` (the entire file — backend is no longer needed)

2. Delete `src/lib/d2.ts` (replaced by `src/lib/mermaid.ts` in Plan 01)

3. Update `package.json`:
   - Change description: "Instant diagram generator using D2 and Ollama" → "Instant diagram generator using Mermaid and Ollama"
   - Update scripts:
     - `"dev"`: change from `"concurrently \"npm run dev:client\" \"npm run dev:server\""` to `"vite"` (just run Vite directly)
     - Remove `"dev:client"` script (redundant, dev now IS the client)
     - Remove `"dev:server"` script (no server)
   - Remove from dependencies: `cors`, `express`
   - Remove from devDependencies: `concurrently`
   - Run `npm install` after editing to update lockfile

4. Update `vite.config.ts`:
   - Remove the entire `proxy` block from `server` config (no more `/api` proxying)
   - Keep the `port: 5173` setting and the `@` alias

5. Update `CLAUDE.md`:
   - Commands section: Remove `npm run dev:client` and `npm run dev:server` entries. Update `npm run dev` description to "Start Vite dev server (port 5173)"
   - Prerequisites: Remove D2 CLI prerequisite entirely. Keep Ollama. Add note that Mermaid is bundled (no install needed)
   - Architecture section:
     - Change "natural-language-to-diagram app" description to mention Mermaid instead of D2
     - Update data flow: "User chat input → useChat hook → Ollama streaming API → extract Mermaid code → client-side mermaid.render() → SVG in WhiteboardPanel"
     - Remove bullet about Express backend for D2→SVG rendering
     - Update "useChat maintains conversation history..." to reference Mermaid instead of D2
     - Update debounce description to note client-side rendering
     - Remove Backend section entirely (no more server/index.js)
     - Update Vite proxy note to say proxying is no longer needed
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run dev` starts only Vite (no Express, no concurrently)
    - `server/index.js` does not exist
    - `src/lib/d2.ts` does not exist
    - `package.json` has no `express`, `cors`, or `concurrently` dependencies
    - `vite.config.ts` has no `proxy` config
    - Grep for "d2" in src/ returns no hits (case-sensitive, excluding node_modules)
  </verify>
  <done>
    - Express backend completely removed
    - D2 rendering library deleted
    - Package dependencies cleaned up (no express, cors, concurrently)
    - Dev script runs Vite only
    - CLAUDE.md accurately documents new Mermaid-based architecture
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README, AGENTS, and GSD planning docs for Mermaid</name>
  <files>README.md, AGENTS.md, .gitignore, .planning/PROJECT.md, .planning/REQUIREMENTS.md, .planning/ROADMAP.md, .planning/STATE.md</files>
  <action>
1. Remove `.planning` from `.gitignore` (planning files should be committed). NOTE: This has already been done by the orchestrator — verify it's not present.

2. Update `README.md`:
   - Title/description: "using D2 and Ollama" → "using Mermaid and Ollama"
   - Overview: "translates natural language descriptions into D2 diagrams" → "translates natural language descriptions into Mermaid diagrams"
   - Features list:
     - "Real-time SVG rendering with D2" → "Real-time SVG rendering with Mermaid (client-side)"
     - "Source code editor for manual D2 tweaks" → "Source code editor for manual Mermaid tweaks"
   - Tech Stack:
     - Remove "**Backend**: Express" line entirely
     - Change "**Diagram Engine**: D2" → "**Diagram Engine**: Mermaid.js (client-side)"
   - Project Structure:
     - Change `lib/           # D2 and Ollama utilities` → `lib/           # Mermaid and Ollama utilities`
     - Remove the entire `server/` section from the tree

3. Update `AGENTS.md`:
   - Project Overview: "using D2 and Ollama" → "using Mermaid and Ollama"
   - Tech Stack: Remove "Express (backend)"
   - Commands section:
     - Change `npm run dev` comment to "Start Vite dev server (port 5173)"
     - Remove `npm run dev:client` and `npm run dev:server` entries
   - Imports example: Change `import { renderD2 } from 'lib/d2'` → `import { renderMermaid } from 'lib/mermaid'`
   - Project Structure:
     - Change `lib/d2.ts` → `lib/mermaid.ts`
     - Remove `server/` section entirely

4. Update `.planning/PROJECT.md` — update current state while preserving history:
   - "What This Is" section: "translates it into D2 diagrams" → "translates it into Mermaid diagrams"
   - "Core Value" section: "without learning D2 syntax" → "without learning diagram syntax"
   - "Active" requirements: "Real-time D2 diagram generation" → "Real-time Mermaid diagram generation", "Local D2 rendering in browser" → "Client-side Mermaid rendering in browser"
   - "Context" section: Replace D2 reference links with Mermaid.js link (https://mermaid.js.org/). Keep Ollama reference.
   - "Key Decisions" table: Update "D2 for all diagrams" row to reflect migration to Mermaid. Add a new row: "Migrated from D2 to Mermaid | Client-side rendering, no CLI dependency, better LLM compatibility | Phase 4"

5. Update `.planning/REQUIREMENTS.md`:
   - Update CORE-02: "receives D2 syntax response" → "receives Mermaid syntax response"
   - Update CORE-03: "renders D2 as SVG" → "renders Mermaid as SVG"
   - Update EDIT-01: "view and manually edit generated D2 source" → "view and manually edit generated Mermaid source"
   - Update EDIT-02: "Manual edits re-render immediately" (this is fine as-is, no D2 reference)

6. Update `.planning/ROADMAP.md`:
   - Update the overview paragraph: mention Mermaid instead of D2 where describing current state
   - Phase 4 section: Update status to reflect it's been planned (not "TBD")
   - Keep phase history intact — phases 1-3 can still reference D2 since that's what was built at the time

7. Update `.planning/STATE.md`:
   - Technical Stack: Change "Backend: Thin Express wrapper for D2 CLI" → remove or note "Backend: None (removed in Phase 4)"
   - Update "Core Value Proposition" to reference Mermaid
   - Add to "Decisions Made": "Phase 4: Migrated from D2 CLI to Mermaid.js for client-side rendering"
   - Update "Current Phase" to 04
  </action>
  <verify>
    - README.md contains "Mermaid" and does not reference D2 as the current rendering engine (historical references OK)
    - AGENTS.md contains "Mermaid" and does not reference D2 as current, no server/ references
    - .planning/PROJECT.md references Mermaid as the diagram engine
    - .planning/REQUIREMENTS.md references Mermaid syntax (not D2) in CORE-02, CORE-03, EDIT-01
    - .gitignore does not contain `.planning`
  </verify>
  <done>
    - All project documentation reflects Mermaid as the current diagram engine
    - GSD planning docs updated to reflect current state
    - .planning directory will be committed going forward
    - Historical references to D2 preserved where appropriate (phase 1-3 plans, roadmap history)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete D2-to-Mermaid migration: client-side rendering, updated system prompt, removed Express backend, cleaned up dependencies</what-built>
  <how-to-verify>
    1. Run `npm run dev` — should start only Vite (no Express server message)
    2. Open http://localhost:5173 — should see a demo flowchart diagram rendered
    3. Click "Edit Source" — modal should say "Edit Mermaid Source" and show Mermaid syntax
    4. Edit the Mermaid source in the editor — live preview should update
    5. Type a diagram request in chat (e.g., "create a sequence diagram of a user login flow") — if Ollama is running, it should generate a Mermaid diagram
    6. Verify undo/redo still works after AI generates a diagram
    7. Verify export (SVG/PNG) still works — click export dropdown, download SVG, confirm it contains valid SVG content from Mermaid rendering
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- `npm run dev` starts Vite only (no Express)
- App loads in browser with a rendered Mermaid demo diagram
- No files reference D2 rendering (grep -r "renderD2\|extractD2\|d2Source\|d2Code" src/ returns nothing)
- `server/` directory can be deleted (or is empty)
- `package.json` has `mermaid` in dependencies, no `express`/`cors`/`concurrently`
- README.md, AGENTS.md reference Mermaid (not D2 as current engine)
- .planning docs reflect Mermaid as current state
</verification>

<success_criteria>
The application runs entirely client-side (except Ollama API). Mermaid diagrams render in the browser. The Express backend and D2 CLI dependency are eliminated. All UI labels reference Mermaid. The developer experience is simplified to a single `npm run dev` command.
</success_criteria>

<output>
After completion, create `.planning/phases/04-switch-from-d2-to-mermaid/04-02-SUMMARY.md`
</output>
