---
phase: 06-use-llm-tool-calling-for-diagram-updates
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/chat.ts
  - src/lib/ollama.ts
  - src/hooks/useChat.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "LLM can use the update_diagram tool when user wants diagram changes"
    - "Diagram updates when LLM calls the tool"
    - "LLM can provide text response alongside diagram updates"
    - "If user asks question without diagram change request, diagram remains unchanged"
    - "System falls back to text extraction if model doesn't support tools"
  artifacts:
    - path: src/types/chat.ts
      provides: "Tool and tool call type definitions"
      contains: "OllamaTool, ToolCall, ToolFunction"
    - path: src/lib/ollama.ts
      provides: "Tool-aware chat streaming"
      exports: ["streamChatWithTools"]
    - path: src/hooks/useChat.ts
      provides: "Tool call handling in chat flow"
      contains: "diagramTool, handleToolCall"
  key_links:
    - from: src/hooks/useChat.ts
      to: src/lib/ollama.ts
      via: "streamChatWithTools function call"
      pattern: "streamChatWithTools.*tools"
    - from: src/lib/ollama.ts
      to: src/types/chat.ts
      via: "Tool types imported"
      pattern: "import.*ToolCall.*from.*chat"
---

<objective>
Implement LLM tool calling capability to enable the AI to update Mermaid diagrams while also providing text responses. The tool allows the LLM to decide when a diagram update is needed based on user intent.

Purpose: Enable more intelligent diagram updates where the LLM can both explain and update, rather than always extracting from text.
Output: Tool-enabled chat flow with fallback support
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06-use-llm-tool-calling-for-diagram-updates/06-RESEARCH.md
@src/lib/ollama.ts
@src/hooks/useChat.ts
@src/types/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tool types to chat.ts</name>
  <files>src/types/chat.ts</files>
  <action>
    Add the following type definitions to src/types/chat.ts:

1. ToolFunction interface with name, description, parameters
2. OllamaTool interface with type: "function" and function property  
3. ToolCall interface for tool invocations from the model (with function.name, function.arguments)
4. Update OllamaMessage to include optional tool_calls and tool_name fields

Add these after the existing StreamCallbacks interface. Export all new types.
  </action>
  <verify>
    Check that TypeScript compiles: npm run build
    Verify types are exported and can be imported in other files
  </verify>
  <done>
    src/types/chat.ts contains: OllamaTool, ToolCall, ToolFunction types with proper exports
  </done>
</task>

<task type="auto">
  <name>Task 2: Add streamChatWithTools to ollama.ts</name>
  <files>src/lib/ollama.ts</files>
  <action>
    Add a new function `streamChatWithTools` to src/lib/ollama.ts that:

1. Accepts an additional `tools: OllamaTool[]` parameter
2. Sends tools in the request body to the /api/chat endpoint
3. Handles streaming response, detecting when message includes tool_calls
4. Returns both the content string AND any tool_calls array
5. Parse tool_call arguments as JSON (they come as stringified JSON string)

Export the function. Keep existing streamChat for backward compatibility.
  </action>
  <verify>
    npm run build succeeds
    Function is exported and accepts tools parameter
  </verify>
  <done>
    streamChatWithTools exported from ollama.ts, accepts tools array, returns {content, toolCalls}
  </done>
</task>

<task type="auto">
  <name>Task 3: Update useChat to handle tool calls</name>
  <files>src/hooks/useChat.ts</files>
  <action>
    Update src/hooks/useChat.ts to:

1. Define `diagramTool` constant - a tool schema for update_diagram with description "Update the Mermaid diagram with new content. Use this when the user wants to create or modify a diagram. If the user is just asking a question without requesting a diagram change, do NOT call this tool."

2. Modify the sendMessage function to:
   - Pass tools: [diagramTool] to streamChatWithTools
   - Handle response with tool_calls:
     - Extract mermaid_code from tool function arguments
     - Render the diagram using renderMermaid
     - Send tool result back to model as a tool message to continue conversation
     - Continue streaming until done
   - If no tool_calls, use existing text extraction behavior (backward compatible)

3. Update system prompt to include tool usage instructions:
   - "Use the update_diagram tool when user wants to create or modify a diagram"
   - "Do NOT use tool if user is just asking a question or not requesting diagram changes"
   - "When using tool, provide COMPLETE diagram code, not just changes"
  </action>
  <verify>
    npm run build succeeds
    App loads without errors in dev mode
  </verify>
  <done>
    useChat uses tool calling with diagramTool, handles tool_calls from LLM, falls back to text extraction
  </done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] App starts in development mode
- [ ] Chat panel displays and accepts input
- [ ] Tool schema is sent to Ollama when available
</verification>

<success_criteria>
Tool calling implementation complete with:
- Tool types defined in chat.ts
- streamChatWithTools function in ollama.ts
- useChat handles tool_calls with fallback to text extraction
- System prompt guides LLM on when to use tool
</success_criteria>

<output>
After completion, create `.planning/phases/06-use-llm-tool-calling-for-diagram-updates/06-01-SUMMARY.md`
</output>
