---
phase: 02-core-chat-to-diagram-loop
plan: '04'
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - src/hooks/useChat.ts
autonomous: true

must_haves:
  truths:
    - "User can say 'add a node' and AI modifies existing diagram"
    - "Conversation history enables iterative refinement"
  artifacts:
    - path: "src/hooks/useChat.ts"
      provides: "Iterative refinement with current diagram context"
---

<objective>
Ensure iterative refinement works - AI understands it's modifying an existing diagram when user makes changes (ITER-01, ITER-02).
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-core-chat-to-diagram-loop/02-RESEARCH.md
@.planning/phases/02-core-chat-to-diagram-loop/02-01-SUMMARY.md
@.planning/phases/02-core-chat-to-diagram-loop/02-02-SUMMARY.md

# Dependencies
@src/hooks/useChat.ts
</context>

<tasks>

<task type="auto">
  <name>Enhance system prompt for iterative refinement</name>
  <files>src/hooks/useChat.ts</files>
  <action>
Update the SYSTEM_PROMPT in useChat to explicitly support iterative changes:

1. Add to SYSTEM_PROMPT:
   - "ITERATIVE REFINEMENT: When user requests changes to an existing diagram (e.g., 'add a node', 'make it bigger', 'change color'), modify the CURRENT DIAGRAM below, not create a new one."
   - Include currentD2 in the prompt as context: "CURRENT DIAGRAM:\n```d2\n{currentD2}\n```"
   - "Only output the modified D2 code, not explanations of what changed"

2. Ensure message history includes:
   - Previous assistant messages with their d2Source
   - When sending to Ollama, format messages to include prior D2 as context

3. Test prompts to include:
   - Initial: "Create a flowchart for order processing"
   - Follow-up: "add a user approval step"
   - Follow-up: "make the arrows thicker"

4. Verify D2 is preserved:
   - If no D2 exists yet, create from scratch
   - If D2 exists, modify it based on user request
   - Always include currentD2 in context when it exists

This ensures ITER-01 and ITER-02 success criteria are met.
  </action>
  <verify>
TypeScript compiles: npx tsc --noEmit
Manual test: Create diagram, then say "add a node", verify it modifies existing diagram
  </verify>
  <done>
System prompt instructs AI to modify existing diagram for iterative requests, maintaining conversation context
  </done>
</task>

</tasks>

<verification>
- [ ] System prompt includes iterative refinement instructions
- [ ] currentD2 passed as context to Ollama
- [ ] Conversation history maintained across messages
- [ ] User can iteratively modify diagrams
</verification>

<success_criteria>
ITER-01: User can request iterative changes ("make it bigger", "add a node")
ITER-02: System maintains conversation context for iterative refinement
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-chat-to-diagram-loop/02-04-SUMMARY.md`
</output>
