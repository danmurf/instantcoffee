---
phase: 02-core-chat-to-diagram-loop
plan: '03'
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - src/hooks/useChat.ts
  - src/components/ChatPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Diagram updates incrementally as AI streams response"
    - "User sees partial D2 rendered while generation continues"
  artifacts:
    - path: "src/hooks/useChat.ts"
      provides: "Streaming D2 extraction and rendering during generation"
---

<objective>
Implement real-time diagram updates as AI streams its response (CORE-04).
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-core-chat-to-diagram-loop/02-RESEARCH.md
@.planning/phases/02-core-chat-to-diagram-loop/02-01-SUMMARY.md
@.planning/phases/02-core-chat-to-diagram-loop/02-02-SUMMARY.md

# Dependencies
@src/hooks/useChat.ts
@src/lib/ollama.ts
@src/lib/d2.ts
</context>

<tasks>

<task type="auto">
  <name>Add streaming D2 extraction to useChat</name>
  <files>src/hooks/useChat.ts</files>
  <action>
Enhance useChat to extract and render D2 during streaming:

1. Add streaming message state:
   - Add streamingContent state to track partial assistant response
   - Add partialD2 state to track D2 extracted so far during streaming

2. Update streamChat callbacks:
   - onChunk: Accumulate chunk to streamingContent, call extractD2Code on accumulated text, if d2Code exists call renderD2(d2Code) to show partial diagram
   
3. Handle partial D2 gracefully:
   - If partial D2 fails to render (invalid), keep previous valid diagram
   - Show visual indicator that diagram is updating (loading shimmer on whiteboard)
   
4. Performance consideration:
   - Debounce renderD2 calls - max once per 500ms during streaming
   - Use a ref to track last render time and skip if <500ms ago

5. Complete flow:
   - On onComplete: final D2 extraction, final render, add complete message to history
   - Clear streamingContent and partialD2 states

Reference: Ollama streaming pattern from 02-RESEARCH.md
  </action>
  <verify>
TypeScript compiles: npx tsc --noEmit
Test: Start Ollama, send "create a flowchart", verify whiteboard updates during generation
  </verify>
  <done>
Diagrams update in real-time as AI streams response, not just at completion
  </done>
</task>

</tasks>

<verification>
- [ ] D2 extracted and rendered during streaming, not just at completion
- [ ] Previous diagram stays visible if partial D2 is invalid
- [ ] Debouncing prevents excessive re-renders
- [ ] Final diagram matches complete AI response
</verification>

<success_criteria>
CORE-04: Diagram updates in real-time as AI generates response (not blocking until complete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-chat-to-diagram-loop/02-03-SUMMARY.md`
</output>
