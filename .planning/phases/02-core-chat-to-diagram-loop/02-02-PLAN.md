---
phase: 02-core-chat-to-diagram-loop
plan: '02'
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/hooks/useChat.ts
  - src/components/ChatPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User types diagram request and sees AI response"
    - "System sends full conversation history to Ollama for context"
    - "Loading indicator shows during generation"
    - "Error message displays if Ollama unavailable"
  artifacts:
    - path: "src/hooks/useChat.ts"
      provides: "Chat state management with Ollama integration"
      exports: ["useChat"]
    - path: "src/components/ChatPanel.tsx"
      provides: "Chat UI connected to useChat hook"
---

<objective>
Implement the chat hook that integrates Ollama with the chat panel, enabling AI-powered diagram generation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-core-chat-to-diagram-loop/02-RESEARCH.md
@.planning/phases/02-core-chat-to-diagram-loop/02-01-SUMMARY.md

# Dependencies
@src/types/chat.ts
@src/lib/ollama.ts
@src/lib/d2.ts
@src/components/ChatPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Create useChat hook</name>
  <files>src/hooks/useChat.ts</files>
  <action>
Create the main chat hook that ties Ollama to diagram rendering:

1. Define SYSTEM_PROMPT constant with:
   - Role: D2 diagram generation assistant
   - Instructions: Generate diagrams for sequence, ERD, flowchart, architecture
   - Format requirement: Always use ```d2 code blocks
   - Reference to D2 syntax: https://d2lang.com/tour/intro

2. Export function `useChat()` that returns:
   - messages: ChatMessage[]
   - currentD2: string
   - isGenerating: boolean
   - error: string | null
   - sendMessage: (content: string) => Promise<void>

3. sendMessage implementation:
   - Validate input, set isGenerating=true, clear error
   - Add user message to state immediately
   - Build API messages: [system prompt, ...history, new user message]
   - Call streamChat with callbacks:
     - onChunk: (optional) could update streaming message
     - onComplete: extract D2 code, add assistant message, call renderD2(currentD2)
     - onError: set error state with formatted message
   - Finally set isGenerating=false
   - Handle case where no D2 extracted: show warning in response

4. Context handling:
   - Include currentD2 in system prompt for iterative refinement
   - Truncate history if >20 messages to prevent context overflow (keep recent)

5. Integrate with d2.ts:
   - Import renderD2 from lib/d2
   - On successful D2 extraction, call renderD2 to update whiteboard

Reference existing ChatPanel for message structure (id, role, content)
  </action>
  <verify>
TypeScript compiles: npx tsc --noEmit
Verify hook exports useChat function
  </verify>
  <done>
src/hooks/useChat.ts exports useChat hook with messages, currentD2, isGenerating, error, sendMessage
  </done>
</task>

<task type="auto">
  <name>Connect ChatPanel to useChat hook</name>
  <files>src/components/ChatPanel.tsx</files>
  <action>
Update ChatPanel.tsx to use the useChat hook:

1. Import useChat from hooks/useChat

2. Replace local state:
   - Remove: messages, isLoading state (now from useChat)
   - Keep: input, textareaRef, messagesEndRef

3. Update handleSubmit:
   - Call sendMessage(input) instead of TODO placeholder
   - Remove the setTimeout mock - now awaits actual generation

4. Update UI for states:
   - isGenerating: show loading indicator (already exists)
   - error: display error banner above messages when present
   - currentD2: the hook handles this internally

5. Error display:
   - Add error banner: red border, error icon, message text, dismiss button
   - Show when error state is set

6. Keep existing:
   - Welcome screen, example prompts, auto-resize textarea, scroll behavior
   - Format message content - handle potential markdown

7. Example prompts update (optional):
   - Add architecture diagram example to match DIAG-04
  </action>
  <verify>
TypeScript compiles: npx tsc --noEmit
App runs: npm run dev and check chat panel loads
  </verify>
  <done>
ChatPanel.tsx connected to useChat hook, sends messages to Ollama, shows loading/error states
  </done>
</task>

</tasks>

<verification>
- [ ] useChat hook implemented with Ollama streaming
- [ ] ChatPanel integrated with useChat
- [ ] Error handling from Ollama shown in UI
- [ ] Loading state displayed during generation
- [ ] TypeScript compiles without errors
</verification>

<success_criteria>
User can type a diagram request and receive AI-generated D2 that renders in the whiteboard
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-chat-to-diagram-loop/02-02-SUMMARY.md`
</output>
