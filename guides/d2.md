# D2 Diagramming Language

**D2 is a modern, declarative, text-to-diagram scripting language developed by Terrastruct.** This reference covers every syntactic feature, keyword, and configuration option. D2 turns plaintext `.d2` files into SVG, PNG, PDF, PPTX, or GIF diagrams. The language prioritizes readability and separates content from styling.

---

## 1. Basic syntax fundamentals

### Declaring shapes

Any unrecognized identifier on its own line creates a shape. By default, shapes are rectangles labeled with their key name.

```d2
# Simple shape declarations
imAShape
im_a_shape
im a shape
i'm a shape
a-shape
```

**Key rules:**
- Keys can contain spaces, single hyphens, underscores, and apostrophes without quoting.
- A single hyphen (`a-shape`) is NOT a connection. A double hyphen (`a--shape`) IS a connection.
- **Keys are case-insensitive**: `postgresql` and `postgreSQL` reference the same shape.
- Semicolons allow multiple declarations on one line: `x; y; z`
- Leading and trailing whitespace in keys and labels is trimmed.

### Labels

By default a shape's label equals its key. Use a colon to set a different label:

```d2
pg: PostgreSQL
my_db: My Database
```

The `label` reserved keyword also works:

```d2
pg.label: PostgreSQL
```

### Comments

Bash-style single-line comments only. No multi-line comment syntax exists.

```d2
# This is a comment
x -> y  # End-of-line comment
```

### Redeclaration and merging

Re-declaring a shape **merges** new attributes with existing ones. The latest explicit label takes priority:

```d2
name: Goodness {
  Language: English
}
name: Goodness {
  Book: Code
}
# Result: name has both Language and Book children, label is "Goodness"
```

### The null keyword

Override with `null` to delete shapes, connections, or attributes:

```d2
one
two
three
three: null           # Deletes 'three'

one -> two
(one -> two)[0]: null # Deletes the connection

one.style.fill: red
one.style.fill: null  # Reverts fill to default
```

Nulling a shape also nulls its connections and descendants (implicit nulls).

---

## 2. All shape types

Set shape type with the `shape` keyword. Default is `rectangle`.

```d2
my_node.shape: cloud
```

### Complete shape type catalog

| Keyword | Description | Notes |
|---|---|---|
| `rectangle` | Rectangle | **Default shape** |
| `square` | Square | 1:1 aspect ratio enforced |
| `circle` | Circle | 1:1 aspect ratio enforced |
| `oval` | Oval / Ellipse | |
| `diamond` | Diamond / Rhombus | |
| `hexagon` | Hexagon | |
| `cloud` | Cloud | |
| `cylinder` | Cylinder | Database symbol |
| `queue` | Queue | |
| `package` | Package | UML package |
| `page` | Page | Dog-eared corner |
| `parallelogram` | Parallelogram | |
| `document` | Document | Wavy bottom edge |
| `step` | Step / Arrow shape | Arrow-like process step |
| `callout` | Callout | Speech bubble |
| `stored_data` | Stored Data | |
| `person` | Person | Stick figure |
| `c4-person` | C4-style Person | Richer person shape for C4 diagrams |
| `text` | Text block | No border, no fill — floating text |
| `code` | Code block | Syntax-highlighted code |
| `class` | UML Class | Special field/method syntax |
| `sql_table` | SQL Table | Special column/constraint syntax |
| `image` | Image | Requires `icon` URL |
| `sequence_diagram` | Sequence Diagram | Special scoping and ordering rules |

### Shape type examples

```d2
server: Production Server {
  shape: rectangle
}
database: Users DB {
  shape: cylinder
}
user: Admin {
  shape: person
}
cloud_provider: AWS {
  shape: cloud
}
decision: Approved? {
  shape: diamond
}
doc: Report {
  shape: page
}
process: Build Step {
  shape: step
}
storage: Archive {
  shape: stored_data
}
msg_queue: RabbitMQ {
  shape: queue
}
api_pkg: API Package {
  shape: package
}
note: Important! {
  shape: callout
}
io: Input {
  shape: parallelogram
}
spec: Specification {
  shape: document
}
avatar: {
  shape: image
  icon: https://icons.terrastruct.com/essentials%2F150-home.svg
}
```

### 1:1 ratio shapes

`circle` and `square` enforce equal width and height. If you set both, D2 uses the larger value.

---

## 3. Connections and edges

### Connection operators

There are exactly **4 connection operators**:

```d2
a -> b      # Forward directed arrow
a <- b      # Backward directed arrow
a <-> b     # Bidirectional arrow
a -- b      # Undirected line (no arrowheads)
```

### Connection labels

Add a label after a colon:

```d2
a -> b: sends data
x -- y: related
client <-> server: bidirectional sync
```

### Implicit shape creation

Referencing an undeclared shape in a connection creates it automatically:

```d2
x -> y    # Both x and y are created as rectangles
```

### Connections reference keys, not labels

```d2
pg: PostgreSQL
db: SQLite
pg -> db    # Correct: use keys 'pg' and 'db', NOT labels
```

### Repeated connections create new edges

Repeated connections do **not** override — they create additional edges:

```d2
Database -> S3: backup
Database -> S3          # A SECOND connection (no label)
Database -> S3: backup  # A THIRD connection
```

### Connection chaining

Define multiple connections in a single line:

```d2
a -> b -> c
a -> b -> c -> d
a -> b: hello -> c: world   # Label applies to each segment
```

### Self-referencing connections (cycles)

```d2
node -> node: self-loop
Stage One -> Stage Two -> Stage Three -> Stage One: repeat
```

### Connection references

Reference a specific connection by index for later styling or modification:

```d2
x -> y: first
x -> y: second
(x -> y)[0].style.stroke: red    # Styles the first connection
(x -> y)[1].style.stroke: blue   # Styles the second connection
(x -> y)[0].style.animated: true
```

### Connection inline block syntax

```d2
a -> b: {
  style: {
    stroke: red
    stroke-dash: 3
    animated: true
  }
  source-arrowhead: 1 {
    shape: diamond
  }
  target-arrowhead: * {
    shape: cf-many
  }
}
```

---

## 4. Arrowhead styles

Override default arrowheads using `source-arrowhead` and `target-arrowhead` special keywords on connections.

### All arrowhead shape options

| Keyword | Description | `style.filled` default | Customizable? |
|---|---|---|---|
| `triangle` | Triangle (default on directed arrows) | filled | Yes: `style.filled: false` for open |
| `arrow` | Pointier arrow | N/A | No |
| `diamond` | Diamond (UML aggregation/composition) | unfilled | Yes: `style.filled: true` for filled |
| `circle` | Circle endpoint | unfilled | Yes: `style.filled: true` |
| `box` | Box/square endpoint | unfilled | Yes: `style.filled: true` |
| `cf-one` | Crow's foot: one | N/A | No |
| `cf-one-required` | Crow's foot: exactly one | N/A | No |
| `cf-many` | Crow's foot: many | N/A | No |
| `cf-many-required` | Crow's foot: many (required) | N/A | No |
| `cross` | X / cross mark | N/A | No |

### Arrowhead syntax examples

```d2
# Diamond arrowhead (UML composition, filled)
a -> b: {
  target-arrowhead: {
    shape: diamond
    style.filled: true
  }
}

# Open/unfilled triangle (UML inheritance)
parent -> child: {
  target-arrowhead: {
    shape: triangle
    style.filled: false
  }
}

# Crow's foot notation (ERD: one-to-many)
users -> orders: {
  source-arrowhead: {
    shape: cf-one
  }
  target-arrowhead: {
    shape: cf-many-required
  }
}

# Arrowhead labels (keep short to avoid collisions)
a -> b: relationship {
  source-arrowhead: 1
  target-arrowhead: * {
    shape: diamond
  }
}

# Bidirectional with mixed arrowheads
a <-> b: {
  source-arrowhead: {
    shape: circle
    style.filled: true
  }
  target-arrowhead: {
    shape: arrow
  }
}

# Cross arrowhead
a -> b: {
  target-arrowhead: {
    shape: cross
  }
}
```

### Default arrowhead behavior

- `->` connections: `target-arrowhead` defaults to filled `triangle`
- `<-` connections: `source-arrowhead` defaults to filled `triangle`
- `<->` connections: both sides default to filled `triangle`
- `--` connections: no arrowheads on either side (can add them explicitly)

---

## 5. Containers and nesting

### Dot notation

```d2
server.process
# Creates: server (container) > process (child)

a.b.c.d
# Creates 4 nested levels
```

### Curly brace nesting

```d2
clouds: {
  aws: {
    load_balancer -> api -> db
  }
  gcloud: {
    auth -> db
  }
}
```

### Container labels

Two equivalent approaches:

```d2
# Shorthand
gcloud: Google Cloud {
  auth -> db
}

# Reserved keyword
gcloud: {
  label: Google Cloud
  auth -> db
}
```

### Parent reference with underscore `_`

Use `_` to reference the parent scope from within a container:

```d2
christmas: {
  presents
}
birthday: {
  presents
  _.christmas.presents -> presents: regift
  _.christmas.style.fill: "#ACE1AF"
}
```

### Cross-container connections

```d2
clouds: {
  aws: AWS {
    load_balancer -> api -> db
  }
  gcloud: Google Cloud {
    auth -> db
  }
  gcloud -> aws
}
users -> clouds.aws.load_balancer
users -> clouds.gcloud.auth
ci.deploy -> clouds
```

---

## 6. Styling

### Style property syntax

Styles are set under the `style` field. Two equivalent syntaxes:

```d2
# Flat/inline syntax
x.style.fill: "#f4a261"
x.style.stroke: red
x.style.stroke-width: 3

# Block syntax
x: {
  style: {
    fill: "#f4a261"
    stroke: red
    stroke-width: 3
  }
}
```

### Complete style property catalog

| Property | Values | Applies to | Notes |
|---|---|---|---|
| `fill` | CSS color, hex, `transparent` | Shapes only | On `sql_table`/`class`: header fill |
| `stroke` | CSS color, hex | Shapes + connections | On `sql_table`/`class`: body fill |
| `stroke-width` | Integer 1–15 | Shapes + connections | |
| `stroke-dash` | Integer 0–10 | Shapes + connections | |
| `border-radius` | Integer 0–20 | Shapes + connections | High values create pill effect |
| `opacity` | Float 0–1 | Shapes + connections | |
| `font-size` | Integer 8–100 | Shapes + connections | |
| `font-color` | CSS color, hex | Shapes + connections | On `sql_table`/`class`: header text only |
| `font` | `mono` | Shapes + connections | Currently only option |
| `bold` | `true`/`false` | Shapes + connections | |
| `italic` | `true`/`false` | Shapes + connections | |
| `underline` | `true`/`false` | Shapes + connections | |
| `shadow` | `true`/`false` | Shapes only | |
| `3d` | `true`/`false` | Rectangle/square only | |
| `multiple` | `true`/`false` | Shapes only | Stacked copies effect |
| `double-border` | `true`/`false` | Rectangles + ovals | |
| `animated` | `true`/`false` | Shapes + connections | Animated dashing |
| `fill-pattern` | `dots`, `lines`, `grain`, `none` | Shapes only | `none` cancels theme patterns |
| `text-transform` | `uppercase`, `lowercase`, `title`, `none` | Shapes + connections | |
| `filled` | `true`/`false` | Arrowheads only | Inside arrowhead blocks |

### Root-level diagram styles

Only these properties work at the diagram root:

```d2
style.fill: "#e3e9fd"          # Diagram background color
style.fill-pattern: dots        # Background pattern
style.stroke: "#0D32B2"        # Frame around diagram
style.stroke-width: 2
style.stroke-dash: 3
style.double-border: true      # Double frame
```

### Styling connections

```d2
# Inline at declaration
a -> b: {
  style: {
    stroke: red
    stroke-width: 3
    stroke-dash: 5
    animated: true
    font-size: 14
    bold: true
  }
}

# By reference
a -> b
(a -> b)[0].style.stroke: red
(a -> b)[0].style.animated: true
```

### Color format examples

```d2
x.style.fill: red                                     # Named CSS color
y.style.fill: "#2ecc71"                               # Hex code (must quote)
z.style.fill: transparent                              # Transparent
```

### Full styling example

```d2
my_shape: Styled Shape {
  style: {
    fill: "#2ecc71"
    stroke: "#27ae60"
    stroke-width: 3
    stroke-dash: 0
    border-radius: 10
    shadow: true
    3d: false
    multiple: true
    double-border: false
    opacity: 0.9
    font-size: 18
    font-color: white
    font: mono
    bold: true
    italic: false
    underline: false
    fill-pattern: dots
    text-transform: uppercase
  }
}
```

---

## 7. Themes

### All available themes

**Light themes:**

| ID | Name |
|----|------|
| 0 | Neutral Default |
| 1 | Neutral Grey |
| 3 | Flagship Terrastruct |
| 4 | Cool Classics |
| 5 | Mixed Berry Blue |
| 6 | Grape Soda |
| 7 | Aubergine |
| 8 | Colorblind Clear |
| 100 | Vanilla Nitro Cola |
| 101 | Orange Creamsicle |
| 102 | Shirley Temple |
| 103 | Earth Tones |
| 104 | Everglade Green |
| 105 | Buttered Toast |

**Special themes:**

| ID | Name | Behavior |
|----|------|----------|
| 300 | Terminal | Caps lock labels, no border-radius, monospaced font, `fill-pattern: dots`, outermost `double-border` |
| 301 | Terminal Grayscale | Similar to Terminal but grayscale |
| 302 | Origami | No corner radius, outermost double-border |
| 303 | C4 | C4 architecture model styling |

**Dark themes:**

| ID | Name |
|----|------|
| 200 | Dark Mauve |
| 201 | Dark Flagship Terrastruct |

### Setting themes

```d2
# Via d2-config in the D2 file
vars: {
  d2-config: {
    theme-id: 4
    dark-theme-id: 200
  }
}
```

```bash
# Via CLI flags
d2 --theme 4 input.d2 output.svg
d2 -t 4 input.d2 output.svg
d2 --dark-theme 200 input.d2 output.svg

# Via environment variables
D2_THEME=4 D2_DARK_THEME=200 d2 input.d2 output.svg
```

CLI flags and environment variables take precedence over `d2-config`.

### Theme overrides

Customize specific theme colors:

```d2
vars: {
  d2-config: {
    theme-id: 300
    theme-overrides: {
      B1: "#000000"
      B2: "#ff0000"
      B3: "#00ff00"
      B4: "#0000ff"
      B5: "#aaaaaa"
      B6: "#eeeeee"
      AA2: "#ff6600"
      AA4: "#cc9900"
      AA5: "#ffcc00"
      AB4: "#66ccff"
      AB5: "#99ddff"
      N1: "#111111"
      N2: "#444444"
      N3: "#888888"
      N4: "#bbbbbb"
      N5: "#dddddd"
      N6: "#f0f0f0"
      N7: "#ffffff"
    }
    dark-theme-overrides: {
      B1: "#ffffff"
      B2: "#6B8AFB"
    }
  }
}
```

Color key reference: `N1`–`N7` = neutral palette, `B1`–`B6` = base colors (containers), `AA2`/`AA4`/`AA5` = alternative A colors, `AB4`/`AB5` = alternative B colors.

### Sketch (hand-drawn) mode

```d2
vars: {
  d2-config: {
    sketch: true
  }
}
```

```bash
d2 --sketch input.d2 output.svg
```

---

## 8. Layout engines and direction

### Available layout engines

| Engine | Type | Key characteristics |
|--------|------|---------------------|
| `dagre` | Hierarchical (default) | Fast, based on Graphviz DOT. Used by MermaidJS. Unmaintained since 2018. |
| `elk` | Hierarchical | Clean orthogonal routes. Academic team maintained. Routes SQL tables to exact columns. Supports container width/height. |
| `tala` | General orthogonal | Proprietary (separate install). Supports `top`/`left`, per-container `direction`, `near` with object IDs, symmetry-aware. |

### Setting layout engine

```d2
# In the D2 file
vars: {
  d2-config: {
    layout-engine: elk
  }
}
```

```bash
# CLI
d2 --layout=elk input.d2 output.svg
d2 --layout=dagre input.d2 output.svg
d2 --layout=tala input.d2 output.svg
```

### Feature compatibility

| Feature | Dagre | ELK | TALA |
|---------|-------|-----|------|
| `near` with constants | ✅ | ✅ | ✅ |
| `near` with object IDs | ❌ | ❌ | ✅ |
| `width`/`height` on containers | ❌ | ✅ | ❌ |
| `top`/`left` position locking | ❌ | ❌ | ✅ |
| Per-container `direction` | ❌ | ❌ | ✅ |
| SQL table exact column routing | ❌ | ✅ | ✅ |
| Grid cell non-straight routing | ❌ | ❌ | ✅ |

### Direction keyword

Controls the flow direction of the diagram:

```d2
direction: right    # Values: up, down, left, right

x -> y -> z
```

**Global direction** works with all layout engines. **Per-container direction** works only with TALA:

```d2
vars: {
  d2-config: {
    layout-engine: tala
  }
}

container1: {
  direction: right
  a -> b -> c
}
container2: {
  direction: down
  x -> y -> z
}
```

---

## 9. Icons and images

### Adding icons to shapes

```d2
deploy: {
  icon: https://icons.terrastruct.com/essentials%2F112-server.svg
}
```

Terrastruct hosts free icons at **https://icons.terrastruct.com** (AWS, GCP, Azure, dev tools, etc.).

### Icon vs image shape

- `icon`: Adds an icon **inside** a normal shape (shape keeps its fill, stroke, label)
- `shape: image`: The entire shape **becomes** the image

```d2
# Icon inside a regular shape
server: {
  icon: https://icons.terrastruct.com/essentials%2F112-server.svg
}

# Shape IS the image
github: {
  shape: image
  icon: https://icons.terrastruct.com/dev%2Fgithub.svg
}
```

### Image sizing

```d2
avatar: {
  shape: image
  icon: https://example.com/photo.png
  width: 200
  height: 150
}
```

### Icon positioning with near

```d2
my_shape: {
  icon: https://icons.terrastruct.com/essentials%2F112-server.svg
  icon.near: top-left
}
```

---

## 10. Classes (style reuse)

### Defining classes

```d2
classes: {
  error: {
    style: {
      fill: "#e74c3c"
      font-color: white
      bold: true
    }
  }
  dashed: {
    style.stroke-dash: 5
  }
  server: {
    shape: image
    icon: https://icons.terrastruct.com/essentials%2F112-server.svg
  }
}
```

### Applying classes

```d2
# Single class on a shape
my_node.class: error

# Multiple classes (array syntax)
my_node.class: [error, dashed]

# On a connection at declaration
a -> b: {
  class: dashed
}

# On a connection by reference
a -> b
(a -> b)[0].class: dashed
```

**Order matters** for multiple classes: applied left-to-right, later classes override earlier ones. An object's own explicit attributes always override class attributes.

### Classes can include non-style attributes

```d2
classes: {
  server: {
    shape: image
    icon: https://icons.terrastruct.com/essentials%2F112-server.svg
  }
}
api.class: server
```

### Classes as SVG tags

Applied classes are written to the SVG `class` attribute, enabling CSS/JS post-processing:

```d2
classes: {
  clickable: {}
}
my_button.class: clickable
# SVG output: <g class="clickable">...</g>
```

### Modular classes via imports

**classes.d2:**
```d2
classes: {
  primary: {
    style.fill: "#2980b9"
    style.font-color: white
  }
}
```

**main.d2:**
```d2
...@classes
user: User { class: primary }
```

---

## 11. Labels, tooltips, and links

### Labels

```d2
# Label = value after colon
x: Hello World

# Label keyword (override separately)
x.label: A Different Label

# Connection labels
a -> b: request data
```

### Tooltips

```d2
x.tooltip: This text appears on hover
```

Tooltips render as hover text in SVG. An icon appears on the shape. Markdown does not render in tooltips (plain text only). When exported to static formats (PNG), tooltips become a numbered appendix.

### Links

```d2
x.link: https://example.com

# Links on connections
a -> b: {
  link: https://google.com
}
```

**Important:** URLs containing `#` must be quoted to avoid comment parsing:

```d2
x.link: "https://example.com/page#section"
```

### Tooltip with permanent display

Combine `tooltip` with `near` to show it permanently (not hover-only):

```d2
ci-runner.tooltip: God has abandoned this pipeline
ci-runner.tooltip.near: bottom-center
```

---

## 12. Markdown and block strings

### Pipe syntax for block strings

```d2
# Markdown label
my_shape: |md
  # Heading
  **bold** and *italic*
  - list item
  - another item
  [link text](https://example.com)
|
```

### Supported markdown features

Headers, bold, italic, ordered/unordered lists, inline code, fenced code blocks, links.

### LaTeX blocks

```d2
formula: |latex
  \\LaTeX = \\sum_{i=0}^n x_i
|

# Alternative tag
formula2: |tex
  \\int_0^\\infty e^{-x} dx
|
```

LaTeX uses MathJax. Does not respect `font-size` styling — use LaTeX commands (`\tiny{}`, `\small{}`, `\large{}`, `\huge{}`). Supported plugins: amscd, braket, cancel, color, gensymb, mhchem, physics.

### Code blocks

```d2
my_code: |go
  func main() {
    fmt.Println("Hello")
  }
|
```

### Language aliases

`md` → markdown, `tex` → latex, `js` → javascript, `go` → golang, `py` → python, `rb` → ruby, `ts` → typescript.

### Escaping pipes in content

If your content contains `|`, use more pipes:

```d2
# Double pipes when content has |
my_ts: ||ts
  const x = a || b;
||

# Triple pipes when content has ||
my_content: |||
  something with || in it
|||

# Or use special symbol after first pipe
my_content: |`
  content with | in it
`|
```

### Markdown on shapes

```d2
my_shape: |md
  # Title
  Some **rich** text
| {
  shape: rectangle
}
```

---

## 13. Text and code shape types

### shape: text

Renders floating text with no border or background:

```d2
explanation: A winning strategy {
  shape: text
}

# Markdown text block
explanation: |md
  ## Architecture Notes
  The system uses a **microservices** pattern.
| {
  shape: text
}
```

### shape: code

Renders syntax-highlighted code with monospace font:

```d2
snippet: |go
  awsSession := From(c.Request.Context())
  client := s3.New(awsSession)
| {
  shape: code
}
```

---

## 14. SQL tables

### Basic syntax

```d2
my_table: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar
  email: varchar {constraint: unique}
  last_updated: timestamp with time zone
}
```

Each key = a column name; value after colon = column type. Constraints go in curly braces.

### Recognized constraints

| Constraint value | Display |
|---|---|
| `primary_key` | PK |
| `foreign_key` | FK |
| `unique` | UNQ |
| Any other string | Displayed as-is |

### Multiple constraints

```d2
my_table: {
  shape: sql_table
  id: int {constraint: [primary_key; unique]}
}
```

### Foreign key connections

```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar
}

orders: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  total: decimal
}

orders.user_id -> users.id
```

With **ELK** or **TALA** layout engines, connections point to the **exact column row**. With Dagre, they point to the table shape generally.

### Styling SQL tables

```d2
my_table: {
  shape: sql_table
  id: int {constraint: primary_key}
  style: {
    fill: "#e0e0e0"        # Applied to HEADER
    stroke: "#333333"       # Applied as fill to BODY
    font-color: "#ffffff"   # Applied to HEADER TEXT only
  }
}
```

### Escaping reserved keywords as column names

```d2
my_table: {
  shape: sql_table
  "label": varchar
  "shape": varchar
  "constraint": text
}
```

---

## 15. UML class diagrams

### Basic syntax

```d2
MyClass: {
  shape: class
  +publicField: string
  -privateField: int
  #protectedField: bool
  +publicMethod(arg: string): int
  -privateMethod(): void
}
```

### Visibility markers

| Prefix | Meaning |
|---|---|
| (none) | Public |
| `+` | Public (explicit) |
| `-` | Private |
| `#` | Protected |

### Fields vs methods

Any key containing `(` is interpreted as a **method**. A method with no value after the colon has return type `void`.

```d2
D2 Parser: {
  shape: class

  # Fields
  +reader: io.RuneReader
  -lookahead: "[]rune"

  # Methods
  +peek(): (r rune, eof bool)
  +rewind()
  -commit(): void
}
```

### Connecting classes

```d2
Customer: {
  shape: class
  +name: string
  +owns(): void
}
DebitCard: {
  shape: class
  +cardno: string
  +access(): void
}
Customer -> DebitCard: owns {
  source-arrowhead.label: 1..*
  target-arrowhead.label: 1..*
}
```

### Styling

Same as SQL tables: `fill` → header, `stroke` → body fill, `font-color` → header text.

---

## 16. Sequence diagrams

### Basic declaration

```d2
my_seq: {
  shape: sequence_diagram
  alice -> bob: What does it mean?
  bob -> alice: I have no idea.
}
```

### Two unique rules for sequence diagrams

1. **Shared scope**: All children share the same scope. `alice` inside any nested group refers to the same actor.
2. **Order matters**: Definition order = visual order (top to bottom for messages, left to right for actors).

### Actor declaration and customization

```d2
my_seq: {
  shape: sequence_diagram

  # Explicit actor order (left to right)
  alice: Alice Anderson
  bob: Bob Builder

  # Actor with a shape
  scorer: {
    shape: person
  }

  # Actor as image
  svc: {
    shape: image
    icon: https://icons.terrastruct.com/dev/docker.svg
  }

  # Actor with styles
  alice: {
    style.stroke: red
    style.fill: lightyellow
  }

  alice -> bob: hello
}
```

### Self-referencing messages

```d2
my_seq: {
  shape: sequence_diagram
  alice -> bob: Can I borrow your car?
  bob -> bob: internal debate ensues
}
```

### Spans (activation boxes)

Created by connecting **nested objects** on actors:

```d2
my_seq: {
  shape: sequence_diagram
  alice -> bob
  alice.a -> bob.b: activate
  bob.b -> alice.a: deactivate
}
```

### Groups (fragments)

A group is a container within `sequence_diagram` that is not connected to anything but has connections inside:

```d2
my_seq: {
  shape: sequence_diagram

  # IMPORTANT: Declare actors BEFORE groups that reference them
  alice
  bob

  shower thoughts: {
    alice -> bob: A physicist is an atom's way of knowing about atoms.
  }
  life advice: {
    alice -> bob: Today is the first day of the rest of your life.
    bob -> alice: If all else fails, lower your standards.
  }
}
```

### Notes

A note is a nested object on an actor with **no connections**:

```d2
my_seq: {
  shape: sequence_diagram
  alice
  bob

  alice."Note text here"
  alice -> bob: hello
}
```

### Styling messages

```d2
my_seq: {
  shape: sequence_diagram
  alice -> bob: async call {
    style.stroke-dash: 3
    style.stroke: red
    style.bold: true
  }
}
```

---

## 17. Grid diagrams

### Creating grids

Set `grid-rows` and/or `grid-columns` on a container:

```d2
# Row-based grid
my_grid: {
  grid-rows: 3
  Executive
  Legislative
  Judicial
}

# Column-based grid
my_grid: {
  grid-columns: 3
  Executive
  Legislative
  Judicial
}

# Both (first defined = dominant direction)
my_grid: {
  grid-rows: 2       # Row-dominant: fills rows first
  grid-columns: 3
  a; b; c; d; e; f
}
```

### Gap settings

```d2
my_grid: {
  grid-rows: 3
  grid-columns: 3
  grid-gap: 20          # Sets both horizontal and vertical gap
  # Or individually:
  # horizontal-gap: 10
  # vertical-gap: 30
  a; b; c; d; e; f; g; h; i
}
```

`grid-gap: 0` creates seamless constructions like data tables.

### Grid width and height

```d2
my_grid: {
  grid-rows: 2
  grid-columns: 3
  width: 800
  a; b; c; d; e; f
}
```

### Connections between grid cells

```d2
my_grid: {
  grid-rows: 2
  grid-columns: 3
  step1; step2; step3; step4; step5; step6
  step1 -> step2
  step2 -> step3
}
```

Grid cell connections are center-to-center straight segments (except with TALA, which uses proper routing).

### Nesting grids

```d2
page: {
  grid-rows: 3
  grid-columns: 1
  header
  content: {
    grid-rows: 1
    grid-columns: 2
    sidebar
    main
  }
  footer
}
```

### Alignment with invisible elements

```d2
my_grid: {
  grid-rows: 2
  grid-columns: 3
  spacer1: "" { style.opacity: 0 }
  centered-item
  spacer2: "" { style.opacity: 0 }
  a; b; c
}
```

---

## 18. Near and position constants

### Positioning shapes with near

Used primarily for titles, legends, and annotations:

```d2
title: My Diagram Title {
  near: top-center
  shape: text
  style.font-size: 28
}

legend: {
  near: bottom-right
}
```

### Position constant values

```
top-left        top-center        top-right
center-left                       center-right
bottom-left     bottom-center     bottom-right
```

### Label and icon positioning

```d2
worker: {
  label.near: outside-top-center
  icon: https://icons.terrastruct.com/tech/worker.svg
  icon.near: outside-left-center
}
```

Additional `outside-` prefix values for labels/icons:

```
outside-top-left       outside-top-center       outside-top-right
outside-left-center                              outside-right-center
outside-bottom-left    outside-bottom-center     outside-bottom-right
```

### Near objects (TALA only)

```d2
explanation: "Explanation near AWS" {
  near: aws
  shape: text
}
aws: AWS { ... }
```

---

## 19. Width, height, top, left constraints

### width and height

```d2
my_shape: Hello {
  width: 200
  height: 100
}
```

Work on **non-container shapes** in all layout engines. Container width/height supported only in **ELK**.

For 1:1 ratio shapes (`circle`, `square`), both dimensions are set to the larger value.

### top and left (TALA only)

Lock absolute positions:

```d2
vars: {
  d2-config: {
    layout-engine: tala
  }
}

fixed: Fixed Position {
  top: 100
  left: 200
}
```

---

## 20. Variables

### Basic syntax

```d2
vars: {
  server-name: Cat
  theme-color: blue
}

${server-name}-1
${server-name}-2
```

### Nested variables

```d2
vars: {
  button: {
    border-radius: 5
    color: red
  }
}

my-button: {
  style.border-radius: ${button.border-radius}
  style.fill: ${button.color}
}
```

### Scoping rules

- Substitutions can reference variables in **outer** scopes
- Cannot reference variables in **inner** scopes
- Inner scope variables override outer scope ones

```d2
vars: {
  region: us-east-1
}

zone1: {
  vars: {
    region: us-west-2
  }
  server: ${region} API   # Uses "us-west-2"
}
```

### Single quotes bypass substitution

```d2
a -> b: 'Send ${names}'   # ${names} is literal text, not substituted
```

### Spread substitutions

```d2
vars: {
  data: {
    a: int {constraint: [PK; NOT NULL; UNQ]}
  }
}

my-table: {
  shape: sql_table
  ...${data}
}
```

### d2-config special variables

```d2
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 1
    dark-theme-id: 200
    pad: 100
    center: true
    sketch: true
    theme-overrides: { ... }
    dark-theme-overrides: { ... }
  }
}
```

---

## 21. Imports

### Regular import

Imports an entire file as a value:

```d2
a: @x           # Imports x.d2 as the value of 'a'
```

### Spread import

Spreads the contents of a file into the current map:

```d2
a: {
  ...@x         # Contents of x.d2 inserted here
}

# Top-level spread
...@classes     # Spread classes.d2 into root scope
```

**Spread imports only work within maps.** `a: ...@x` is invalid.

### Partial imports

Import specific objects:

```d2
joe: @people.joe      # Import only 'joe' from people.d2
```

### File path rules

- Omit the `.d2` extension (autoformatter enforces this)
- Relative imports are relative to the file, not the execution path
- Absolute imports: `@/absolute/path/to/file`
- Filenames with dots must be quoted: `@"schema-v0.1.2"`

```d2
a: @../sibling-dir/file
b: @./same-dir/file        # Autoformatted to @same-dir/file
```

---

## 22. Globs

### Single-level glob `*`

Matches all objects at the current scope level:

```d2
*.style.fill: orange

iphone 10
iphone 11 mini
iphone 12
```

Globs apply both **backwards** (to already declared shapes) and **forwards** (to shapes declared later).

### Recursive glob `**`

Targets all nested levels recursively:

```d2
**.style.fill: orange     # All shapes at all nesting levels
```

### Global/triple glob `***`

Applies globally across layers and imports:

```d2
***.style.fill: orange    # Persists across all boards and imported files
```

### Glob connections

```d2
* -> *                    # Connect all shapes (self-connections omitted)
** -> **                  # Connect all leaf shapes recursively
```

### Pattern matching

```d2
*er: {style.fill: orange}    # Matches shapes ending in "er"
th*: {style.fill: blue}      # Matches shapes starting with "th"
d*: {style.fill: orange}     # Case insensitive matching
```

### Scoped globs

Globs only apply within their scope:

```d2
foods: {
  *.style.fill: orange     # Only applies within foods container
  pizza
  cheese
}
humans: {
  john                      # NOT affected
}
```

### Styling connections via globs

```d2
lady 1 -> barbie
lady 2 -> barbie
(* -> barbie)[*].style.stroke: red   # Style all connections to barbie
(* -> *)[*].style.stroke: "#666"     # Style all connections
```

### Filters

Filter which shapes a glob targets:

```d2
# Shape type filter
*: {
  &shape: circle
  style.fill: orange       # Only circles get orange fill
}

# Inverse filter
*: {
  !&shape: circle
  style.fill: blue          # Everything EXCEPT circles
}

# Property filters
**: {
  &leaf: true               # Only leaf (non-container) shapes
  style.fill: orange
}

*: {
  &connected: true          # Only shapes with connections
  style.stroke-width: 3
}

# Filter by any attribute
*: {
  &link: *                  # Only shapes that have a link set
  style.fill: blue
}

# Multiple filters (AND)
*: {
  &shape: circle
  &style.fill: red
  style.stroke: blue        # Only red circles
}
```

### Connection endpoint filters

```d2
(* -> *)[*]: {
  &src-style.fill: red      # Only connections FROM red shapes
  style.stroke: orange
}
```

---

## 23. Layers, scenarios, and steps

### Layers (independent boards)

Each layer starts as a completely blank board with **no inheritance**:

```d2
title: Network Overview

layers: {
  detailed: {
    server1 -> server2
    server2 -> database
  }
  simplified: {
    frontend -> backend
  }
}
```

### Scenarios (inherit from base)

Scenarios inherit ALL objects from the base layer:

```d2
local.code -> github.dev: commit
github.dev -> github.master: merge

scenarios: {
  hotfix: {
    # Inherits everything above
    local.code -> github.master: commit          # Add new connection
    github.dev -> github.master: null            # Remove inherited connection
    (local.code -> github.dev)[0].style.opacity: 0.1  # Modify inherited
  }
}
```

### Steps (sequential inheritance)

Each step inherits from the **previous step** (first step inherits from parent):

```d2
Chicken's plan

steps: {
  1: {
    Approach road
  }
  2: {
    # Inherits "Approach road" from step 1
    Cross road
  }
  3: {
    # Inherits both "Approach road" and "Cross road"
    Make you wonder why
  }
}
```

### Animated diagrams

```bash
d2 --animate-interval=1200 input.d2 output.svg
```

### Board links

Link between boards using underscore navigation:

```d2
title: Overview {
  link: _.layers.detailed
}

layers: {
  detailed: {
    back: {
      link: _              # Link back to parent board
    }
  }
}
```

### Nesting composition

```d2
layers: {
  network: {
    server -> db
    scenarios: {
      overloaded: {
        server.style.fill: red
      }
    }
    steps: {
      1: { server -> cache }
      2: { cache -> db }
    }
  }
}
```

### Export formats

Multi-board diagrams can be exported as animated SVG/GIF (`--animate-interval`), PDF (each board = page), or PPTX (each board = slide).

---

## 24. Suspend and unsuspend (model-view pattern)

Used for defining models once and creating multiple views:

```d2
# Define all models
Restaurants: {
  Chipotle
  Burger King
}
Diners: {
  daniel
  zack
}
daniel -> Chipotle: likes
zack -> Burger King: likes

# Suspend everything
**.suspend: true
(** -> **)[*].suspend: true

# Unsuspend only what you want to show
*.unsuspend: true
(* -> *)[*].unsuspend: true
```

---

## 25. Escaping and special characters

### Unquoted strings

Keys and labels can contain spaces, single hyphens, underscores, and apostrophes without quoting. Unquoted strings cannot contain `{`, `}`, `:`, `#`, `;`, or arrow operators.

### Quoted strings

Single and double quotes have identical behavior:

```d2
"$$$": money
'###': tags
"it's a \"test\""
```

### Using reserved keywords as identifiers

Quote them:

```d2
"label": My Shape
"shape": Another Shape
"null": Not Null
"style": My Style Node
```

### Block strings with pipes

For multiline content including special characters:

```d2
my_shape: |md
  # Heading with special chars: {} -> : #
|
```

---

## 26. Complete reserved keywords reference

### Shape attribute keywords

| Keyword | Description |
|---|---|
| `shape` | Shape type |
| `label` | Display label |
| `icon` | Icon URL |
| `link` | Clickable URL |
| `tooltip` | Hover text |
| `near` | Position constant or object ID |
| `width` | Explicit width in pixels |
| `height` | Explicit height in pixels |
| `top` | Absolute Y position (TALA only) |
| `left` | Absolute X position (TALA only) |
| `direction` | Flow direction (`up`, `down`, `left`, `right`) |
| `class` | Apply defined class(es) |
| `constraint` | SQL table column constraint |
| `suspend` | Mark for model-view deletion |
| `unsuspend` | Restore suspended object |

### Container/composition keywords

| Keyword | Description |
|---|---|
| `style` | Style properties container |
| `vars` | Variables block |
| `classes` | Class definitions block |
| `layers` | Independent board compositions |
| `scenarios` | Base-inheriting board compositions |
| `steps` | Sequential-inheriting board compositions |

### Grid keywords

| Keyword | Description |
|---|---|
| `grid-rows` | Number of grid rows |
| `grid-columns` | Number of grid columns |
| `grid-gap` | Gap between all cells |
| `vertical-gap` | Vertical gap between rows |
| `horizontal-gap` | Horizontal gap between columns |

### Connection keywords

| Keyword | Description |
|---|---|
| `source-arrowhead` | Override source arrowhead (shape, label, style.filled) |
| `target-arrowhead` | Override target arrowhead (shape, label, style.filled) |

### Special syntax elements

| Element | Syntax | Description |
|---|---|---|
| Null | `null` | Delete/remove a shape, connection, or attribute |
| Parent reference | `_` | Reference parent scope from within a container |
| Single glob | `*` | Match all at current scope |
| Recursive glob | `**` | Match all recursively |
| Global glob | `***` | Match globally across layers/imports |
| Filter | `&key: value` | Filter glob targets |
| Inverse filter | `!&key: value` | Exclude from glob targets |
| Import | `@filepath` | Regular import |
| Spread import | `...@filepath` | Spread file contents into map |
| Substitution | `${varname}` | Variable substitution |
| Spread substitution | `...${varname}` | Spread variable contents |

---

## 27. Comprehensive end-to-end example

```d2
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
    dark-theme-id: 200
    sketch: false
    pad: 50
  }
  primary-color: "#2980b9"
}

classes: {
  server: {
    shape: image
    icon: https://icons.terrastruct.com/essentials%2F112-server.svg
  }
  highlight: {
    style: {
      fill: "#ffe0b2"
      stroke: "#ff9800"
      stroke-width: 2
      shadow: true
      bold: true
    }
  }
  dashed-conn: {
    style: {
      stroke-dash: 5
      stroke: "#999"
    }
  }
}

direction: right
style.fill: "#fafafa"

title: System Architecture {
  near: top-center
  shape: text
  style.font-size: 28
  style.bold: true
}

# Shapes with various types
user: End User {
  shape: person
  style.fill: lightyellow
}

cloud: Cloud Infrastructure {
  api: API Gateway {
    class: highlight
    icon: https://icons.terrastruct.com/essentials%2F092-network.svg
  }
  services: {
    auth: Auth Service { class: server }
    payments: Payment Service { class: server }
    notifications: Notification Service {
      class: server
      style.multiple: true
    }
  }
  data: {
    db: Users DB {
      shape: cylinder
      style.fill: "#e8f5e9"
    }
    cache: Redis Cache {
      shape: cylinder
      style.3d: true
    }
    queue: Message Queue {
      shape: queue
      style.multiple: true
    }
  }
}

# Schema
schema: {
  users: {
    shape: sql_table
    id: int {constraint: primary_key}
    name: varchar
    email: varchar {constraint: unique}
    created_at: timestamp
  }
  orders: {
    shape: sql_table
    id: int {constraint: primary_key}
    user_id: int {constraint: foreign_key}
    total: decimal
    status: varchar
  }
  orders.user_id -> users.id
}

# Connections
user -> cloud.api: REST calls {
  style.animated: true
  target-arrowhead: {
    shape: arrow
  }
}
cloud.api -> cloud.services.auth: validate {
  class: dashed-conn
}
cloud.api -> cloud.services.payments: process
cloud.services.payments -> cloud.data.db: write {
  source-arrowhead: 1
  target-arrowhead: * {
    shape: cf-many
  }
}
cloud.services.payments -> cloud.data.queue: publish
cloud.data.queue -> cloud.services.notifications: consume {
  style.animated: true
}
cloud.services.auth -> cloud.data.cache: session lookup

# Sequence diagram
auth_flow: Authentication Flow {
  shape: sequence_diagram
  client: Client App
  gateway: API Gateway
  auth: Auth Service
  db: Database

  client -> gateway: POST /login
  gateway -> auth: validate credentials
  auth -> db: query user
  db -> auth: user record
  auth -> auth: generate JWT
  auth -> gateway: JWT token
  gateway -> client: 200 OK + token
}

# Layers for different views
layers: {
  monitoring: {
    direction: right
    grafana: Grafana {
      shape: rectangle
      icon: https://icons.terrastruct.com/dev%2Fgrafana.svg
    }
    prometheus: Prometheus {
      shape: cylinder
    }
    alertmanager: Alert Manager
    grafana -> prometheus: query metrics
    prometheus -> alertmanager: fire alerts
  }
}
```

---

## 28. Quick-reference patterns for common tasks

### Flowchart

```d2
direction: down
start: Start {shape: oval}
decision: Approved? {shape: diamond}
process: Process Order {shape: step}
end: End {shape: oval}
start -> decision
decision -> process: Yes
decision -> end: No
process -> end
```

### ERD with crow's foot

```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar
}
posts: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  title: varchar
}
users -> posts: {
  source-arrowhead: {shape: cf-one}
  target-arrowhead: {shape: cf-many-required}
}
```

### Architecture diagram with icons

```d2
vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 4
  }
}
user: User {shape: person}
lb: Load Balancer {
  icon: https://icons.terrastruct.com/aws%2FNetworking%20%26%20Content%20Delivery%2FElastic-Load-Balancing.svg
}
api1: API 1 {style.multiple: true}
db: Database {shape: cylinder}
user -> lb -> api1 -> db
```

### Animated step-by-step

```d2
steps: {
  1: {
    client: Client
    server: Server
    client -> server: SYN
  }
  2: {
    server -> client: SYN-ACK
  }
  3: {
    client -> server: ACK
    established: Connection Established {
      shape: text
      near: bottom-center
    }
  }
}
```

### Grid-based dashboard layout

```d2
dashboard: {
  grid-rows: 2
  grid-columns: 2
  grid-gap: 10
  
  metrics: Metrics Panel {
    style.fill: "#e3f2fd"
  }
  alerts: Active Alerts {
    style.fill: "#fce4ec"
  }
  logs: Recent Logs {
    style.fill: "#e8f5e9"
  }
  health: System Health {
    style.fill: "#fff3e0"
  }
}
```

### Bulk styling with globs

```d2
classes: {
  blue: {style.fill: "#e3f2fd"; style.stroke: "#1565c0"}
}

# Apply to all shapes
*.class: blue
# Style all connections
(* -> *)[*].style.stroke: "#666"
(* -> *)[*].style.stroke-width: 2

a -> b -> c -> d
```

### Import and compose

**styles.d2:**
```d2
classes: {
  primary: {style.fill: "#2196F3"; style.font-color: white}
  danger: {style.fill: "#f44336"; style.font-color: white}
}
```

**main.d2:**
```d2
...@styles
server: Production {class: primary}
alert: Critical Error {class: danger}
server -> alert: triggers
```